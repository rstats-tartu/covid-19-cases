---
title: "R Notebook"
output: html_notebook
---

```{r}
library("tidyverse")
library("readxl")
library("here")
library("glue")
library("directlabels")
library("jcolors")
library("lubridate")
```

```{r}
#taavi kood
if (!dir.exists(here("data"))) {
  system(glue("mkdir {here('data')}"))
}
yesterday <- Sys.Date() - 1
dataset <- here(glue("data/COVID-19-geographic-disbtribution-worldwide-{yesterday}.xlsx"))
if (!file.exists(dataset)) {
  url <- glue("https://www.ecdc.europa.eu/sites/default/files/documents/COVID-19-geographic-disbtribution-worldwide-{yesterday}.xlsx")
  system(glue("curl -o {dataset} {url}"))
} 

#' Importing downloaded dataset.
#+ import
sheet_1 <- excel_sheets(dataset)[1]
covid <- read_excel(dataset, sheet = sheet_1)
covid <- covid %>% 
  rename(Country = `Countries and territories`) %>% 
  rename_all(tolower) %>% 
  mutate(date = paste(year, month, day, sep = "-"))

```

```{r}
cov <- covid %>% arrange(geoid, daterep) %>% 
  group_by(geoid) %>% 
  mutate(cumulative_cases= cumsum(cases), 
         cumulative_deaths=cumsum(deaths), 
         risk=cumulative_deaths/cumulative_cases,
         lag_cases_7 = dplyr::lag(cumulative_cases, n=7),
         risk_7=cumulative_deaths/lag_cases_7,
         smoothed_cases = zoo::rollmean(cases, k=3, fill=NA),
         smoothed_deaths =zoo::rollmean(deaths, k=3, fill=NA))

cov1 <- cov %>% group_by(country) %>% filter(max(cumulative_cases)>10000)

#taavi kood:
covid_by_country1 <- covid %>% 
  filter(cases > 100) %>% 
  group_by(country) %>% 
  mutate(tp = interval(yesterday, daterep) / ddays(1),
         tp = tp - min(tp))
lag_n <- 7
covid_cum1 <- covid_by_country1 %>% 
  mutate(cum_cases = with_order(tp, cumsum, cases),
         cum_deaths = with_order(tp, cumsum, deaths),
         risk = cum_deaths / cum_cases,
         risk_lag = cum_deaths / lag(cum_cases, n = lag_n, order_by = tp)) %>% 
  ungroup() %>% filter(geoid != "JPG11668")

covid_by_country2 <- covid %>% 
  filter(deaths > 20) %>% 
  group_by(country) %>% 
  mutate(tp = interval(yesterday, daterep) / ddays(1),
         tp = tp - min(tp))
lag_n <- 7
covid_cum2 <- covid_by_country2 %>% 
  mutate(cum_cases = with_order(tp, cumsum, cases),
         cum_deaths = with_order(tp, cumsum, deaths),
         risk = cum_deaths / cum_cases,
         risk_lag = cum_deaths / lag(cum_cases, n = lag_n, order_by = tp)) %>% 
  ungroup() %>% filter(geoid != "JPG11668")
```


# 1. globaalne

## Uute nakatumiste arv
```{r}
ggplot(covid %>% filter(daterep> "2020-03-01"), aes(daterep, cases, color=geoid))+
  geom_col()+
  ggthemes::theme_tufte()+
  theme(legend.position = "none")+
  xlab(NULL)
```

## Uute surmade arv 
```{r}
ggplot(covid %>% filter(daterep> "2020-03-01"), aes(daterep, deaths, color=geoid))+
  geom_col()+
  ggthemes::theme_tufte()+
  theme(legend.position = "none")+
  xlab(NULL)
```

## Uued nakatumised ja uued surmad log-skaalas.
```{r warning=FALSE, message=FALSE}
ggplot(covid %>% filter(daterep> "2020-03-01"), 
       aes(daterep, cases))+
  geom_col(fill="grey")+
  geom_col(aes(y=deaths), fill="black")+
  ggthemes::theme_tufte()+
  theme(legend.position = "none")+
  xlab(NULL)+
  ylab(NULL)+
  scale_y_log10(breaks=NULL)
```

## uued nakatumised, silutud liikuva keskmisega (k=3)
```{r warning=FALSE}
ggplot(cov %>% filter(daterep> "2020-03-01"), 
       aes(daterep, smoothed_cases, color=geoid))+
  geom_line()+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))+
  ggthemes::theme_tufte()+
  theme(legend.position = "none")+
  xlab(NULL)
```

## uued surmad, silutud liikuva keskmisega (k=3)
```{r}
ggplot(cov %>% filter(daterep> "2020-03-01"), aes(daterep, smoothed_deaths, color=geoid))+
  geom_line()+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))+
  ggthemes::theme_tufte()+
  theme(legend.position = "none")+
  xlab(NULL)
```

## kumulatiivne nakatunute arv riigiti.
```{r}
ggplot(cov %>% filter(daterep> "2020-03-01"), 
       aes(daterep, cumulative_cases, color=geoid))+
  geom_line()+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))+
  ggthemes::theme_tufte()+
  theme(legend.position = "none")+
  xlab(NULL)
```

riikide epideemiad on alguspunkti järgi joondatud
```{r}
covid_cum1 %>% 
  ggplot(aes(tp, cum_cases, color = country)) +
  geom_line() +
  geom_dl(aes(label = geoid), method = list("last.points", cex = 0.8)) +
  scale_y_log10() +
  labs(x = "Days since first case in each country", 
       y = "Cumulative number of cases")+
  ggthemes::theme_tufte()+
  theme(legend.position = "none")+
  xlab(NULL)
```

alla 100 kumulatiivse haigusjuhu on eemaldatud, et jooni paremini kohakuti saada.

## kumulatiivne nakatunute arv riigiti: suurimad nakkuskolded

```{r}
ggplot(cov1 %>% filter(daterep> "2020-03-05"), aes(daterep, cumulative_cases, color=country))+
  geom_line()+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))+
  scale_color_jcolors(palette = "rainbow")+
  ggthemes::theme_tufte()+
  theme(legend.position = "none")+
  xlab(NULL)
```

## Kumulatiivsed surmad: suurimad nakkuskolded
```{r}
ggplot(cov1 %>% filter(daterep> "2020-03-01"), aes(daterep, cumulative_deaths, color=country))+
  geom_line()+
  ggthemes::theme_tufte()+
  xlab(NULL)+
  scale_color_jcolors(palette = "rainbow")+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))+
  theme(legend.position = "none")
```

```{r}
#taavi kood
covid_cum2 %>% 
  ggplot(aes(tp, cum_deaths)) +
  geom_line(aes(color = country)) +
  geom_dl(aes(label = geoid), method = list("last.points", cex = 0.8)) +
  scale_y_log10() +
  labs(x = "Days since first death in each country", 
       y = "Cumulative number of deaths")+
  ggthemes::theme_tufte()+
  theme(legend.position = "none")
```

alla 20 kumulatiivse surma on pildilt eemaldatud, et jooni paremini kohakuti saada.

## Suremine tormab testimisest mõõda:
```{r}
ggplot(cov1 %>% filter(daterep> "2020-03-05"), aes(daterep, risk, color=country))+
  geom_line()+
  ggthemes::theme_tufte()+
  xlab(NULL)+
  scale_color_jcolors(palette = "rainbow")+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))+
  theme(legend.position = "none")
```
risk = cumulative deaths / cumulative cases

## 7-päevases nihkes haigusjuhtude surmarisk on stabiilsem.

risk_7 = cumulative deaths / cumulative cases_lag_7

```{r}
ggplot(cov1 %>% filter(daterep> "2020-03-18"), aes(daterep, risk_7, color=country))+
  geom_line()+
 ggthemes::theme_tufte()+
  xlab(NULL)+
  scale_color_jcolors(palette = "rainbow")+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))
```

riskihinnangute konvergents 7-päevase nihkega andmete peal
```{r warning=FALSE}
covid_cum %>% 
  ggplot(aes(tp, risk_lag)) +
  geom_line(aes(color = country)) +
  geom_dl(aes(label = geoid), method = list("last.points", cex = 0.8)) +
  scale_y_log10() +
  labs(x = "Time, days from first case", 
       y = "Risk of death")+
  ggthemes::theme_tufte()+
   theme(legend.position = "none")
```


# 2. Eesti võrdluses lähinaabritega

## kumulatiivne nakatunute arv riigiti
```{r}
ggplot(cov %>% filter(daterep> "2020-03-05", 
                      country %in% c("Estonia", 
                                     "Finland", 
                                     "Latvia", 
                                     "Russia", 
                                     "Lithuania",
                                     "Sweden")), 
       aes(daterep, cumulative_cases, color=country))+
  geom_line()+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))+
  ggthemes::theme_tufte()+
  #theme(legend.position = "none")+
  xlab(NULL)
```

## Kumulatiivsed surmad
```{r}
ggplot(cov %>% filter(daterep> "2020-03-05", 
                      country %in% c("Estonia", 
                                     "Finland", 
                                     "Latvia", 
                                     "Russia", 
                                     "Lithuania",
                                     "Sweden")), 
       aes(daterep, cumulative_deaths, color=country))+
  geom_line()+
  ggthemes::theme_tufte()+
  xlab(NULL)
```

# 3. Eesti

## Uute nakatumiste arv Eestis
```{r}
ggplot(covid %>% filter(daterep> "2020-03-01", country== "Estonia"), 
       aes(daterep, cases))+
  geom_col()+
  ggthemes::theme_tufte()+
  theme(legend.position = "none")+
  xlab(NULL)+
  ylab("registreeritud haigusjuhud")
```