---
title: "Covid-19 pandeemia"
author: rstats-tartu
date: "`r Sys.Date()`"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```



```{r}
library("tidyverse")
library("lubridate")
library("readxl")
library("here")
library("glue")
library("directlabels")
library("jcolors")
```



```{r pkgs}
library("dplyr")
library("tidyr")
library("readr")
library("directlabels")
library("jcolors")
library("lubridate")
library("ggplot2")
library("ggthemes")
library("zoo")
library("here")
library("glue")
old <- theme_set(ggthemes::theme_tufte())

```


```{r}
#taavi kood

#' Importing downloaded dataset.
#+ import
path <- here("data/COVID-19-geographic-disbtribution-worldwide.csv")
covid <- read_csv(path)
covid <- covid %>% 
  rename(Country = `Countries and territories`) %>% 
  rename_all(tolower) %>% 
  mutate(date = paste(year, month, day, sep = "-"))

```

```{r}
cov <- covid %>% arrange(geoid, daterep) %>% 
  group_by(geoid) %>% 
  mutate(cumulative_cases= cumsum(cases), 
         cumulative_deaths=cumsum(deaths), 
         risk=cumulative_deaths/cumulative_cases,
         lag_cases_7 = dplyr::lag(cumulative_cases, n=7),
         risk_7=cumulative_deaths/lag_cases_7,
         smoothed_cases = zoo::rollmean(cases, k=3, fill=NA),
         smoothed_deaths =zoo::rollmean(deaths, k=3, fill=NA)
         ) 
cov$country[cov$country == "United_States_of_America"] <- "US"



df1 <- read_csv("data/country_data.csv") %>% 
  unique() %>% 
  filter(country != "Diamond Princess")
df1$country[df1$country == "United Arab Emirates"] <- "United_Arab_Emirates"
df1$country[df1$country == "United Kingdom"] <- "United_Kingdom"
df1$country[df1$country == "Taiwan*"] <- "Taiwan"
df1$country[df1$country == "South Africa"] <- "South_Africa"
df1$country[df1$country == "Sri Lanka"] <- "Sri_Lanka"
df1$country[df1$country == "Saudi Arabia"] <- "Saudi_Arabia"
df1$country[df1$country == "San Marino"] <- "San_Marino"
df1$country[df1$country == "North Macedonia"] <- "North_Macedonia"
df1$country[df1$country == "New Zealand"] <- "New_Zealand"
df1$country[df1$country == "Korea, South"] <- "South_Korea"
df1$country[df1$country == "Dominican Republic"] <- "Dominican_Republic"
df1$country[df1$country == "Bosnia and Herzegovina"] <- "Bosnia_and_Herzegovina"

cov <- cov %>% left_join(df1)
cov <- cov %>% mutate(cases_per_100000= (cumulative_cases/population)*100000, 
                      deaths_per_100000= (cumulative_deaths/population)*100000)
#cov <- cov %>% drop_na(region)
#cov <- unique(cov)

cov1 <- cov %>% group_by(country) %>% filter(max(cumulative_cases)>10000)

#taavi kood:
covid_by_country1 <- covid %>% 
  filter(cases > 100) %>% 
  group_by(country) %>% 
  mutate(tp = interval(Sys.Date(), daterep) / ddays(1),
         tp = tp - min(tp))
lag_n <- 7
covid_cum1 <- covid_by_country1 %>% 
  mutate(cum_cases = with_order(tp, cumsum, cases),
         cum_deaths = with_order(tp, cumsum, deaths),
         risk = cum_deaths / cum_cases,
         risk_lag = cum_deaths / lag(cum_cases, n = lag_n, order_by = tp)) %>% 
  ungroup() %>% filter(geoid != "JPG11668")

covid_by_country2 <- covid %>% 
  filter(deaths > 3) %>% 
  group_by(country) %>% 
  mutate(tp = interval(Sys.Date(), daterep) / ddays(1),
         tp = tp - min(tp))
lag_n <- 7
covid_cum2 <- covid_by_country2 %>% 
  mutate(cum_cases = with_order(tp, cumsum, cases),
         cum_deaths = with_order(tp, cumsum, deaths),
         risk = cum_deaths / cum_cases,
         risk_lag = cum_deaths / lag(cum_cases, n = lag_n, order_by = tp)) %>% 
  ungroup() %>% filter(geoid != "JPG11668")
```


# Globaalne

## Uute nakatumiste arv

```{r}

ggplot(cov %>% filter(daterep> "2020-03-01"), aes(daterep, cases, fill=region))+
  geom_col()+
  theme(axis.title.x = element_blank())
```

## Uute surmade arv 

```{r}
ggplot(cov %>% filter(daterep> "2020-03-01"), aes(daterep, deaths, fill=region))+
  geom_col()+
  theme(axis.title.x = element_blank())
```

## Uued nakatumised ja uued surmad log-skaalas

```{r}
ggplot(covid %>% filter(daterep > "2020-03-01"), 
       aes(daterep, cases))+
  geom_col(fill="grey")+
  geom_col(aes(y=deaths), fill="black")+
  theme(legend.position = "none", axis.title = element_blank()) +
  scale_y_log10(breaks=NULL)
```

## Uued nakatumised, silutud liikuva keskmisega (k=3)

```{r}
ggplot(cov %>% filter(daterep> "2020-03-01"), 
       aes(daterep, smoothed_cases, group=country, color=region))+
  geom_line()+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))+
  theme(legend.position = "none", axis.title.x = element_blank())
```

## Uued surmad, silutud liikuva keskmisega (k=3)

```{r}
ggplot(cov %>% filter(daterep> "2020-03-01"), aes(daterep, smoothed_deaths,  group=country, color=region))+
  geom_line()+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))+
  theme(legend.position = "none", axis.title.x = element_blank())
```

## Kumulatiivne nakatunute arv riigiti

```{r}
ggplot(cov %>% filter(daterep> "2020-03-01"), 
       aes(daterep, cumulative_cases, group=country, color=region))+
  geom_line()+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))+
  theme(legend.position = "none", axis.title.x = element_blank())
```

## Riikide epideemiad on alguspunkti järgi joondatud

```{r}
covid_cum1 %>% 
  ggplot(aes(tp, cum_cases, color = country)) +
  geom_line() +
  geom_dl(aes(label = geoid), method = list("last.points", cex = 0.8)) +
  scale_y_log10() +
  labs(x = "Days since first case in each country", 
       y = "Cumulative number of cases")+
  theme(legend.position = "none", axis.title.x = element_blank()) +
  xlim(0, 40)
```

Alla 100 kumulatiivse haigusjuhu on eemaldatud, et jooni paremini kohakuti saada.



## Kumulatiivsed surmad: suurimad nakkuskolded

```{r}
ggplot(cov1 %>% filter(daterep> "2020-03-01"), aes(daterep, cumulative_deaths, color=country))+
  geom_line()+
  xlab(NULL)+
  scale_color_jcolors(palette = "rainbow")+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))+
  theme(legend.position = "none")
```

```{r}
#taavi kood
covid_cum2 %>% 
  ggplot(aes(tp, cum_deaths)) +
  geom_line(aes(color = country)) +
  geom_dl(aes(label = geoid), method = list("last.points", cex = 0.8)) +
  scale_y_log10() +
  labs(x = "Days since first death in each country", 
       y = "Cumulative number of deaths")+
  theme(legend.position = "none")
```


alla 5 kumulatiivse surma on pildilt eemaldatud, et jooni paremini kohakuti saada.

## Kumulatiivne haigestumine: haigeid ja surnuid 100 000 kohta

```{r}
ggplot(cov %>% filter(daterep> "2020-03-01", 
                      geoid != "SM", 
                      geoid != "AD", 
                      geoid != "LU", 
                      geoid != "LI"), 
       aes(daterep, cases_per_100000, group=country, color=region))+
  geom_line()+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))+
  theme(legend.position = "none", axis.title.x = element_blank())
```

```{r}
ggplot(cov %>% filter(daterep> "2020-03-01",
                       geoid != "SM", 
                      geoid != "AD", 
                      geoid != "LU", 
                      geoid != "LI"), 
       aes(daterep, deaths_per_100000, group=country, color=region))+
  geom_line()+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))+
  theme(legend.position = "none", axis.title.x = element_blank())
```

Alla 20 kumulatiivse surma on pildilt eemaldatud, et jooni paremini kohakuti saada.

## Suremine tormab testimisest mööda


```{r}
ggplot(cov1 %>% filter(daterep> "2020-03-05"), aes(daterep, risk, color=country))+
  geom_line()+
  xlab(NULL)+
  scale_color_jcolors(palette = "rainbow")+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))+
  theme(legend.position = "none") +
  labs(caption = "risk = cumulative deaths / cumulative cases")
```


### Riskihinnangute konvergents 7-päevase nihkega andmete peal

```{r warning=FALSE}
covid_cum1 %>% 
  ggplot(aes(tp, risk_lag)) +
  geom_line(aes(color = country)) +
  geom_dl(aes(label = geoid), method = list("last.points", cex = 0.8)) +
  scale_y_log10() +
  labs(x = "Time, days from first case", 
       y = "Risk of death")+
   theme(legend.position = "none")
```



# Eesti võrdluses lähinaabritega

## Kumulatiivne nakatunute arv riigiti

```{r}
ggplot(cov %>% filter(daterep> "2020-03-05", 
                      country %in% c("Estonia", 
                                     "Finland", 
                                     "Latvia", 
                                     "Russia", 
                                     "Lithuania",
                                     "Sweden")), 
       aes(daterep, cumulative_cases, color=country))+
  geom_line()+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))+
  theme(legend.position = "none", axis.title.x = element_blank())
```

## Kumulatiivsed surmad

```{r}
ggplot(cov %>% filter(daterep> "2020-03-05", 
                      country %in% c("Estonia", 
                                     "Finland", 
                                     "Latvia", 
                                     "Russia", 
                                     "Lithuania",
                                     "Sweden")), 
       aes(daterep, cumulative_deaths, color=country))+
  geom_line()+
  theme(legend.position = "none", axis.title.x = element_blank())
```

## nakatumisi 100 000 elaniku kohta
```{r}
ggplot(cov %>% filter(daterep> "2020-03-05", 
                      country %in% c("Estonia", 
                                     "Finland", 
                                     "Latvia", 
                                     "Russia", 
                                     "Lithuania",
                                     "Sweden")), 
       aes(daterep, cases_per_100000, color=country))+
  geom_line()+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))+
  theme(legend.position = "none", axis.title.x = element_blank())

```

## surmi 100 000 elaniku kohta
```{r}
ggplot(cov %>% filter(daterep> "2020-03-05", 
                      country %in% c("Estonia", 
                                     "Finland", 
                                     "Latvia", 
                                     "Russia", 
                                     "Lithuania",
                                     "Sweden")), 
       aes(daterep, deaths_per_100000, color=country))+
  geom_line()+
  geom_dl(aes(label = geoid), method = list(dl.combine("last.points"), cex = 0.8))+
  theme(legend.position = "none", axis.title.x = element_blank())
```

# 3. Eesti


## Uute nakatumiste arv Eestis

```{r}
ggplot(covid %>% filter(daterep> "2020-03-01", country== "Estonia"), 
       aes(daterep, cases))+
  geom_col()+
  theme(legend.position = "none", axis.title.x = element_blank())+
  ylab("Registreeritud haigusjuhud")
```

